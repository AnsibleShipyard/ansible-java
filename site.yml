---
- hosts: all
  sudo: True
  tasks:
    - action: group_by key={{ ansible_distribution }}

- hosts: Ubuntu
  gather_facts: no
  sudo: True
  vars:
    java_version: "6"
    libjvm_path: "/usr/lib/jvm/java-{{java_version}}-*/jre/lib/*/server/libjvm.so"
    libjvm_symlink_path: "/usr/lib/libjvm.so"
  tasks:
    - name: Install os packages
      apt: pkg={{item}} state=present update_cache=yes
      with_items: 
        - openjdk-{{java_version}}-jre-headless
        - openjdk-{{java_version}}-jdk

    - name: Resolve {{libjvm_path}}
      shell: find {{libjvm_path}}
      register: libjvm_path_resolved

    # Here we get back to ansible land...
    - name: Check for {{libjvm_path_resolved}}
      stat: path={{libjvm_path_resolved.stdout}}
      register: libjvm

    - name: Link libjvm
      shell: ln -nsf {{libjvm_path_resolved.stdout}} {{libjvm_symlink_path}}
      when: libjvm.stat.exists == true

    - name: Check if symlink created
      stat: path={{libjvm_symlink_path}}
      register: libjvm_symlink

    - fail: msg="Could not create libjvm symlink {{libjvm_symlink_path}}"
      when: libjvm_symlink.stat.exists == False
